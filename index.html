<!DOCTYPE html>
<html lang="en">

<head>
    <title>Preview3dX</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="lib/three/examples/main.css">
    <style>
        html,
        window {
            background-color: black;
            overflow: hidden;
        }

        canvas[data-engine] {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
    <style>
        /* cyrillic-ext */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-19-7DRs5.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-19a7DRs5.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* greek-ext */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-1967DRs5.woff2) format('woff2');
            unicode-range: U+1F00-1FFF;
        }

        /* greek */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-19G7DRs5.woff2) format('woff2');
            unicode-range: U+0370-03FF;
        }

        /* vietnamese */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-1927DRs5.woff2) format('woff2');
            unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+1EA0-1EF9, U+20AB;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-19y7DRs5.woff2) format('woff2');
            unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Roboto Condensed';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(./assets/fonts/ieVl2ZhZI2eCN5jzbjEETS9weq8-19K7DQ.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
    </style>
    <style>
        :root {
            --tp-font-family: 'Roboto Condensed', sans-serif;
            --tp-base-background-color: hsla(230, 20%, 11%, 1.00);
            --tp-base-shadow-color: hsla(0, 0%, 0%, 0.2);
            --tp-button-background-color: hsla(230, 10%, 80%, 1.00);
            --tp-button-background-color-active: hsla(230, 10%, 95%, 1.00);
            --tp-button-background-color-focus: hsla(230, 10%, 90%, 1.00);
            --tp-button-background-color-hover: hsla(230, 10%, 85%, 1.00);
            --tp-button-foreground-color: hsla(230, 20%, 11%, 1.00);
            --tp-container-background-color: hsla(230, 25%, 16%, 1.00);
            --tp-container-background-color-active: hsla(230, 25%, 31%, 1.00);
            --tp-container-background-color-focus: hsla(230, 25%, 26%, 1.00);
            --tp-container-background-color-hover: hsla(230, 25%, 21%, 1.00);
            --tp-container-foreground-color: hsla(230, 10%, 80%, 1.00);
            --tp-groove-foreground-color: hsla(230, 20%, 8%, 1.00);
            --tp-input-background-color: hsla(230, 20%, 8%, 1.00);
            --tp-input-background-color-active: hsla(230, 28%, 23%, 1.00);
            --tp-input-background-color-focus: hsla(230, 28%, 18%, 1.00);
            --tp-input-background-color-hover: hsla(230, 20%, 13%, 1.00);
            --tp-input-foreground-color: hsla(230, 10%, 80%, 1.00);
            --tp-label-foreground-color: hsla(230, 12%, 48%, 1.00);
            --tp-monitor-background-color: hsla(230, 20%, 8%, 1.00);
            --tp-monitor-foreground-color: hsla(230, 12%, 48%, 1.00);
        }
    </style>
    <style>
        body.production .pane {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        body.production:hover .pane {
            opacity: 0.2;
        }

        body.production:hover .pane:hover {
            opacity: 1;
        }

        .pane.inspect {
            right: auto;
            left: 8px;
        }

        .pane.about {
            top: auto;
            bottom: 8px;
        }
    </style>
</head>

<body>
    <script src="./lib/tweakpane.min.js"></script>
    <script async src="./lib/lodash.min.js"></script>
    <script async src="./lib/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "./lib/three/build/three.module.js",
                "three/addons/": "./lib/three/examples/jsm/"
            }
        }
    </script>
    <script type="module">


        import * as THREE from 'three';

        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { KTX2Loader } from 'three/addons/loaders/KTX2Loader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { MeshoptDecoder } from 'three/addons/libs/meshopt_decoder.module.js';

        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';

        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { SSAOPass } from 'three/addons/postprocessing/SSAOPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        let info_text = `
Feature-rich 
application 
to preview 
3d models

* * *

Author:
  Prototyped and implemented: 
    @sanyabeast
  Icon: 
    @nataleesha
  Kyiv, Ukraine, 2023;

* * *

Special thaks to:
  Mr. Doob 
    and THREE.js team
  Electron team
  Tweakpane team
        `;

        let prev_frame_date = +new Date()
        let target_fps = 45
        let os_tools = window.os_tools
        let controls
        let camera, global_scene, renderer;
        let torch_light
        let axes_helper, grid_helper_10, grid_helper_100, grid_helper_1000
        let composer
        let main_pane, inspect_pane, about_pane

        let params = {
            env_enabled: true,
            env_texture_src: 'assets/atelier.hdr',
            env_default_background: null,
            env_default_texture: null,
            env_texture: null,
            postfx_enabled: false,
            postfx_bloom_exposure: 1,
            postfx_bloom_strength: 0.2,
            postfx_bloom_treshold: 0.5,
            postfx_bloom_radius: 0.2,
            camera_fov: 45,
            scene_src: window.file_to_open,
            resolution_scale: 1,
            active_scene: null,
            show_gizmo: true,
            torch_light: false,
            info: [
                { label: 'Preview3dX', value: info_text }
            ],
            check_updates: true
        }

        /** loaders */
        let ktx2Loader,
            dracoLoader,
            gltf_loader,
            fbx_loader,
            obj_loader,
            mtl_loader;

        let loaders = {
            hdr: (texture_src) => {
                new RGBELoader().load(texture_src, function (texture) {
                    params.env_texture = texture
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    global_scene.background = texture;
                    global_scene.environment = texture;
                    render();

                });
            },
            gltf: (scene_src) => {
                /** --- */
                const base_path = os_tools.path.dirname(scene_src);
                const model_path = os_tools.path.basename(scene_src);
                console.log(base_path)

                gltf_loader = gltf_loader || new GLTFLoader()
                    .setDRACOLoader(dracoLoader)
                    .setKTX2Loader(ktx2Loader)
                    .setMeshoptDecoder(MeshoptDecoder)

                gltf_loader.load(scene_src, function (gltf) {
                    set_active_scene(gltf.scene)
                });
            },
            glb: (scene_src) => loaders.gltf(scene_src),
            fbx: (scene_src) => {
                fbx_loader = fbx_loader || new FBXLoader();
                fbx_loader.load(scene_src, function (object) {
                    set_active_scene(object)

                });
            },
            obj: (scene_src) => {
                let base_path = os_tools.path.dirname(scene_src)
                obj_loader = obj_loader || new OBJLoader()
                mtl_loader = mtl_loader || new MTLLoader()

                try {
                    mtl_loader.load(scene_src.replace('.obj', '.mtl'), function (materials) {
                        console.log(materials)
                        materials.preload();
                        obj_loader.setMaterials(materials)
                        obj_loader.load(scene_src, function (object) {
                            set_active_scene(object)
                        });
                    })
                } catch (err) {
                    console.error(err)
                    obj_loader.load(scene_src, function (object) {
                        set_active_scene(object)
                    });
                }
            }
        }

        init();
        render();

        function init() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const container = document.createElement('div');
            document.body.appendChild(container);
            document.body.classList.add(window.IS_DEVELOPMENT ? 'development' : 'production')

            /** main renderer */
            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMappingExposure = 1;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);
            /* main scene setup */
            camera = new THREE.PerspectiveCamera(params.camera_fov, window.innerWidth / window.innerHeight, 0.1, 1000000);
            camera.position.set(0, 100, 0);

            setup_global_scene()
            setup_postfx()
            setup_controls()
            setup_loaders()
            setup_gui()

            /* loading assets */
            loaders['hdr'](params.env_texture_src)
            load_scene()

            if (params.check_updates === true) {
                setTimeout(check_updates, 1000)
            }
        }

        function set_active_scene(scene) {
            if (scene.isObject3D) {
                if (params.active_scene) {
                    console.log('removing scene...')
                    global_scene.remove(params.active_scene)
                }

                params.active_scene = scene
                params.scene_aabb = new THREE.Box3();
                params.scene_aabb.setFromObject(scene);
                frame_object()
                console.log('spawning scene...')
                console.log(scene)
                global_scene.add(scene);
                update_title()
            }

            render();
            setTimeout(render, 500)
        }

        function handle_drag_and_drop(event) {
            event.preventDefault()
            if (event.dataTransfer && event.dataTransfer.files.length > 0) {
                let file_path = event.dataTransfer.files[0].path
                params.scene_src = os_tools.path.resolve(file_path)
                load_scene()
            }
        }

        function setup_global_scene() {
            const environment = new RoomEnvironment();
            const pmremGenerator = new THREE.PMREMGenerator(renderer);

            global_scene = new THREE.Scene();
            global_scene.background = new THREE.Color(0xbbbbbb);
            global_scene.environment = pmremGenerator.fromScene(environment).texture;
            environment.dispose();

            let sun = new THREE.DirectionalLight()
            let amb = new THREE.AmbientLight()
            amb.intensity = 0.2;
            sun.position.set(1000, 1000, 1000)
            sun.intensity = 1
            global_scene.add(sun)
            global_scene.add(amb)
            torch_light = new THREE.PointLight()
            torch_light.intensity = 0.5
            torch_light.visible = params.torch_light
            global_scene.add(torch_light)

            axes_helper = new THREE.AxesHelper(2);
            axes_helper.visible = params.show_gizmo
            global_scene.add(axes_helper)

            grid_helper_10 = new THREE.GridHelper(10, 10, 0xffffff, 0xffffff);
            grid_helper_10.material.opacity = 0.1;
            grid_helper_10.material.depthWrite = false;
            grid_helper_10.material.transparent = true;
            grid_helper_10.visible = params.show_gizmo
            global_scene.add(grid_helper_10);

            grid_helper_100 = new THREE.GridHelper(100, 10, 0xffffff, 0xffffff);
            grid_helper_100.material.opacity = 0.1;
            grid_helper_100.material.depthWrite = false;
            grid_helper_100.material.transparent = true;
            grid_helper_100.visible = params.show_gizmo
            global_scene.add(grid_helper_100);


            grid_helper_1000 = new THREE.GridHelper(1000, 10, 0xffffff, 0xffffff);
            grid_helper_1000.material.opacity = 0.1;
            grid_helper_1000.material.depthWrite = false;
            grid_helper_1000.material.transparent = true;
            grid_helper_1000.visible = params.show_gizmo
            global_scene.add(grid_helper_1000);

            params.env_default_background = global_scene.background
            params.env_default_texture = global_scene.environment
        }

        function setup_postfx() {
            const render_pass = new RenderPass(global_scene, camera);
            const bloom_pass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloom_pass.threshold = params.postfx_bloom_treshold;
            bloom_pass.strength = params.postfx_bloom_strength;
            bloom_pass.radius = params.postfx_bloom_radius;
            const ssao_pass = new SSAOPass(global_scene, camera, window.innerWidth, window.innerHeight);
            ssao_pass.kernelRadius = 8;
            composer = new EffectComposer(renderer);
            composer.addPass(render_pass);
            composer.addPass(bloom_pass);
            //composer.addPass(ssao_pass);

        }

        function setup_gui() {
            main_pane = new Tweakpane.Pane()
            main_pane.element.parentElement.classList.add('pane')
            main_pane.element.parentElement.classList.add('main')

            let viewport_settings_folder = main_pane.addFolder({
                title: "Viewport",
                expanded: false
            })

            /* main tab */
            viewport_settings_folder.addInput(params, 'postfx_enabled', { label: 'Postprocessing' }).on('change', ({ value }) => {
                render()
            });
            viewport_settings_folder.addInput(params, 'env_enabled', { label: 'Environment' }).on('change', ({ value }) => {
                if (value) {
                    global_scene.background = params.env_texture;
                    global_scene.environment = params.env_texture;
                } else {
                    global_scene.background = params.env_default_background;
                    global_scene.environment = params.env_default_texture;
                }
                render()
            });
            viewport_settings_folder.addInput(params, 'camera_fov', { label: "Camera FOV", min: 1, max: 120, step: 1 }).on('change', ({ value }) => {
                camera.fov = value
                camera.updateProjectionMatrix()
                render()
            });
            viewport_settings_folder.addInput(params, 'resolution_scale', { label: "Resolution", min: 0.5, max: 1, step: 0.05 }).on('change', ({ value }) => {
                handle_window_resized()
                render()
            });


            viewport_settings_folder.addInput(params, 'torch_light', { label: "Torchlight" }).on('change', ({ value }) => {
                torch_light.visible = value
                render()
            });

            /** about tab */
            about_pane = new Tweakpane.Pane()
            about_pane.element.parentElement.classList.add('pane')
            about_pane.element.parentElement.classList.add('about')
            let about_folder = about_pane.addFolder({ title: "About", expanded: false })
            params.info.forEach((item, index) => {
                about_folder.addMonitor(item, 'value', {
                    label: item.label, multiline: true,
                    lineCount: 32,
                })
            })

            /* inspect pane */
            inspect_pane = new Tweakpane.Pane()
            inspect_pane.element.parentElement.classList.add('pane')
            inspect_pane.element.parentElement.classList.add('inspect')

            let file_folder = inspect_pane.addFolder({ title: "File", expanded: false })
            file_folder.addMonitor(params, 'scene_src', { label: "Current" })

            let inspect_folder = inspect_pane.addFolder({ title: "Inspect", expanded: false })

            inspect_folder.addInput(params, 'show_gizmo', { label: "Gizmo" }).on('change', ({ value }) => {
                axes_helper.visible = value
                grid_helper_10.visible = value
                grid_helper_100.visible = value
                grid_helper_1000.visible = value
                render()
            });
        }

        function setup_controls() {
            document.body.addEventListener('dragenter', handle_drag_and_drop, false)
            document.body.addEventListener('dragleave', handle_drag_and_drop, false)
            document.body.addEventListener('dragover', handle_drag_and_drop, false)
            document.body.addEventListener('drop', handle_drag_and_drop, false)

            window.addEventListener("keydown", (event) => {
                switch (event.keyCode) {
                    case 70: {
                        frame_object();
                        break;
                    }
                    case 32: {
                        frame_object();
                        break;
                    }
                }
            })

            controls = new OrbitControls(camera, renderer.domElement);
            controls.addEventListener('change', render); // use if there is no animation loop
            controls.minDistance = 0;
            controls.maxDistance = Infinity;
            controls.target.set(0, 0, 0);
            controls.object.position.set(0, 256, 512)
            controls.update();
            window.addEventListener('resize', handle_window_resized);
            handle_window_resized()
        }

        function frame_object() {
            let max_value = Math.max(
                Math.abs(params.scene_aabb.min.x),
                Math.abs(params.scene_aabb.min.y),
                Math.abs(params.scene_aabb.min.z),
                Math.abs(params.scene_aabb.max.x),
                Math.abs(params.scene_aabb.max.y),
                Math.abs(params.scene_aabb.max.z)
            )

            controls.target.set(
                (params.scene_aabb.min.x + params.scene_aabb.max.x) / 2,
                (params.scene_aabb.min.y + params.scene_aabb.max.y) / 2,
                (params.scene_aabb.min.z + params.scene_aabb.max.z) / 2
            );
            axes_helper.scale.setScalar(max_value / 2)
            // grid_helper.scale.setScalar(max_value / 2)
            console.log(max_value)
            controls.object.position.set(0, max_value * 2, max_value * 4)
            controls.saveState()
            controls.reset()
        }

        function setup_loaders() {
            ktx2Loader = new KTX2Loader()
                .setTranscoderPath('lib/three/examples/jsm/libs/basis/')
                .detectSupport(renderer);

            dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('lib/three/examples/jsm/libs/draco/gltf/');
        }

        function load_scene(scene_src) {
            if (scene_src !== undefined) {
                params.scene_src = os_tools.path.resolve(scene_src)
            }

            let model_format = os_tools.path.extname(params.scene_src).replace(".", '')
            try {
                loaders[model_format](params.scene_src)
            } catch (error) {
                console.error(error)
            }
        }

        function handle_window_resized() {
            const width = Math.floor(window.innerWidth * params.resolution_scale);
            const height = Math.floor(window.innerHeight * params.resolution_scale);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            if (composer) {
                composer.setSize(width, height);
            }
            render()
        }



        function render() {
            if (+new Date() - prev_frame_date < 1000 / target_fps) return
            prev_frame_date = +new Date()
            /** --- */
            torch_light.position.copy(camera.position)

            if (params.postfx_enabled) {
                composer.render();
            } else {
                renderer.render(global_scene, camera);
            }
        }

        function update_title() {
            document.querySelector('head title').innerHTML = `Preview3dX ${PACKAGE_INFO.version} | ${params.scene_src}`
        }

        function check_updates() {
            console.log('checking for updates...')
            let xhr = new XMLHttpRequest()
            xhr.open('get', 'https://raw.githubusercontent.com/sanyabeast/preview3dx/main/package.json', false)
            xhr.send()
            console.log(xhr.responseText)
        }



        window.load_file = function (file_path) {
            load_scene(file_path)
        }
    </script>

</body>

</html>